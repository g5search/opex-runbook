(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{364:function(e,t,a){"use strict";a.r(t);var s=a(42),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"deployments-using-docker-and-kubernetes-aka-k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployments-using-docker-and-kubernetes-aka-k8s"}},[e._v("#")]),e._v(" Deployments using Docker and Kubernetes (aka K8s)")]),e._v(" "),a("p",[e._v("Our current deployment process uses several technologies.")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://cloud.google.com/sdk/docs/install",target:"_blank",rel:"noopener noreferrer"}},[e._v("Install Google Cloud SDK"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://hub.docker.com/editions/community/docker-ce-desktop-mac",target:"_blank",rel:"noopener noreferrer"}},[e._v("Install Docker Desktop"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Install Kubernetes"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://helm.sh/docs/intro/install/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Install Helm"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v('(Optional) Install "kubectx" via Homebrew. '),a("code",[e._v("brew install kubectx")]),e._v(".")])]),e._v(" "),a("blockquote",[a("p",[e._v("NOTE: This workflow may change to use G5's CLI.")])]),e._v(" "),a("h2",{attrs:{id:"build-your-server-image-locally"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-your-server-image-locally"}},[e._v("#")]),e._v(" Build your server image locally")]),e._v(" "),a("p",[e._v("Most of OpEx apps have scripts already defined in the NPM package.json at the root of the project. You will want to define some build variables before runing Docker.")]),e._v(" "),a("p",[e._v("Copy the "),a("code",[e._v(".buildenv")]),e._v(" template file.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cp")]),e._v(" .buildenv.TEMPLATE .buildenv\n")])])]),a("p",[e._v("Fill out each of the variables. These are variables that are only consumed when compiling and are different than runtime variables. Most are consumed directly by Nuxt.js, Vue.js, or its plugins.")]),e._v(" "),a("blockquote",[a("p",[e._v("The "),a("code",[e._v("BROWSER_URL")]),e._v(" changes dependending on where you are deploying.")])]),e._v(" "),a("p",[e._v("Build, tag, and push. "),a("code",[e._v("<context>")]),e._v(" in each command is either "),a("code",[e._v("prod")]),e._v(", "),a("code",[e._v("staging")]),e._v(", or "),a("code",[e._v("prime")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run docker:build\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run docker:tag:"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("context"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ex. npm run docker:tag:staging")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run docker:push:"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("context"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("p",[e._v("Upgrade the deployment.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" run helm:upgrade:"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("context"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ex. npm run helm:upgrade:prod")]),e._v("\nkubectl get pods\n")])])]),a("p",[e._v("You should see new pods spinning up.")]),e._v(" "),a("blockquote",[a("p",[e._v("Staging and Prime deployments tag their images based on the commit SHA and branch name. If you are redeploying without adding a new commit or changing branches, new pods may not initialize after upgrading. Restart the deployment to finish the upgrade.")])]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl rollout restart deployement "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("app_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("h2",{attrs:{id:"manage-attached-redis-instances-via-debian"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manage-attached-redis-instances-via-debian"}},[e._v("#")]),e._v(" Manage Attached Redis Instances via Debian")]),e._v(" "),a("p",[e._v("Since the Redis instance isn't exposed publicly, and the app may not have tasks to manage the instance directly, you may need to use the "),a("code",[e._v("redis-cli")]),e._v(" to communicate with the instance.")]),e._v(" "),a("p",[a("strong",[e._v("Spin Up Debian Pod")])]),e._v(" "),a("p",[e._v("Make sure your K8s context includes the redis instance you want to manage.")]),e._v(" "),a("p",[e._v("Deploy a Debian pod.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl run redis-pod --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("debian -it -- "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bash")]),e._v("\n")])])]),a("p",[e._v("This will end with a command prompt. Install redis tools.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" update "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y redis-tools\n")])])]),a("p",[e._v("Retrieve the private IP for your Redis instance from the Memstore>Redis product in Google Cloud Console. Connect to it via the redis-cli.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("redis-cli -h "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("IP of redis instance"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# do not include the TCP port")]),e._v("\n")])])]),a("p",[e._v("Run your redis commands from here.")]),e._v(" "),a("p",[a("strong",[e._v("To Exit")])]),e._v(" "),a("p",[e._v("Keep typing "),a("code",[e._v("exit")]),e._v(" until you get to your local shell.")]),e._v(" "),a("p",[e._v("Remove your pod.")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl delete pod redis-pod\n")])])]),a("h2",{attrs:{id:"useful-kubernetes-commands"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#useful-kubernetes-commands"}},[e._v("#")]),e._v(" Useful Kubernetes Commands")]),e._v(" "),a("p",[e._v("Occasionally, you will accidentally deploy an app to the wrong context. For apps that use Helm and Istio's virtual service the domain routing may get confused. You may even try to fix this, but find that Helm will not deploy the fix despite you fixing the Yaml. Can you force an update or patch?")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("helm get manifest <deployment> | k apply -f -\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);
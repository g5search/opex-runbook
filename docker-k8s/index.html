<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deployments using Docker and Kubernetes (aka K8s)</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/opex-runbook/assets/css/0.styles.eb7c3e77.css" as="style"><link rel="preload" href="/opex-runbook/assets/js/app.b1c4424b.js" as="script"><link rel="preload" href="/opex-runbook/assets/js/2.83008ae0.js" as="script"><link rel="preload" href="/opex-runbook/assets/js/9.c8b60c0a.js" as="script"><link rel="prefetch" href="/opex-runbook/assets/js/10.5dba1746.js"><link rel="prefetch" href="/opex-runbook/assets/js/11.2e108f7e.js"><link rel="prefetch" href="/opex-runbook/assets/js/12.8d951890.js"><link rel="prefetch" href="/opex-runbook/assets/js/13.e032895e.js"><link rel="prefetch" href="/opex-runbook/assets/js/14.52a8b68b.js"><link rel="prefetch" href="/opex-runbook/assets/js/15.7a6397ff.js"><link rel="prefetch" href="/opex-runbook/assets/js/16.841c3c7a.js"><link rel="prefetch" href="/opex-runbook/assets/js/17.59f76975.js"><link rel="prefetch" href="/opex-runbook/assets/js/18.a9f81dec.js"><link rel="prefetch" href="/opex-runbook/assets/js/19.9fce8cdc.js"><link rel="prefetch" href="/opex-runbook/assets/js/20.b91a0368.js"><link rel="prefetch" href="/opex-runbook/assets/js/3.b27e4937.js"><link rel="prefetch" href="/opex-runbook/assets/js/4.7c7cbcb6.js"><link rel="prefetch" href="/opex-runbook/assets/js/5.766016c4.js"><link rel="prefetch" href="/opex-runbook/assets/js/6.3a0262d0.js"><link rel="prefetch" href="/opex-runbook/assets/js/7.b14d29dc.js"><link rel="prefetch" href="/opex-runbook/assets/js/8.aba08b34.js">
    <link rel="stylesheet" href="/opex-runbook/assets/css/0.styles.eb7c3e77.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/opex-runbook/" class="home-link router-link-active"><img src="/opex-runbook/midnight-g5-logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/opex-runbook/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started Menu" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started Menu" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opex-runbook/getting-started/prerequisites/" class="nav-link">
  Prerequisites
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/getting-started/installation/" class="nav-link">
  Installation
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/postgres/" class="nav-link">
  Postgres
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/domain-forwarder/" class="nav-link">
  Domain Forwarder
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Testing Menu" class="dropdown-title"><span class="title">Testing</span> <span class="arrow down"></span></button> <button type="button" aria-label="Testing Menu" class="mobile-dropdown-title"><span class="title">Testing</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/general-testing-info/" class="nav-link">
  General Testing Info
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/unit-testing/" class="nav-link">
  Unit Testing
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/regression-testing/" class="nav-link">
  Regression Testing
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/smoke-testing/" class="nav-link">
  Smoke Testing
</a></li></ul></div></div><div class="nav-item"><a href="/opex-runbook/contributing/" class="nav-link">
  Contributing
</a></div><div class="nav-item"><a href="/opex-runbook/getting-started/contact/" class="nav-link">
  Contact
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/opex-runbook/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Getting Started Menu" class="dropdown-title"><span class="title">Getting Started</span> <span class="arrow down"></span></button> <button type="button" aria-label="Getting Started Menu" class="mobile-dropdown-title"><span class="title">Getting Started</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opex-runbook/getting-started/prerequisites/" class="nav-link">
  Prerequisites
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/getting-started/installation/" class="nav-link">
  Installation
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/postgres/" class="nav-link">
  Postgres
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/domain-forwarder/" class="nav-link">
  Domain Forwarder
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Testing Menu" class="dropdown-title"><span class="title">Testing</span> <span class="arrow down"></span></button> <button type="button" aria-label="Testing Menu" class="mobile-dropdown-title"><span class="title">Testing</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/general-testing-info/" class="nav-link">
  General Testing Info
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/unit-testing/" class="nav-link">
  Unit Testing
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/regression-testing/" class="nav-link">
  Regression Testing
</a></li><li class="dropdown-item"><!----> <a href="/opex-runbook/testing/smoke-testing/" class="nav-link">
  Smoke Testing
</a></li></ul></div></div><div class="nav-item"><a href="/opex-runbook/contributing/" class="nav-link">
  Contributing
</a></div><div class="nav-item"><a href="/opex-runbook/getting-started/contact/" class="nav-link">
  Contact
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/opex-runbook/" aria-current="page" class="sidebar-link">Welcome to the OpEx Runbook!</a></li><li><a href="/opex-runbook/node/" class="sidebar-link">Configuring your Node.js Environment</a></li><li><a href="/opex-runbook/docker-k8s/" aria-current="page" class="active sidebar-link">Deployments using Docker and Kubernetes (aka K8s)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/opex-runbook/docker-k8s/#build-your-server-image-locally" class="sidebar-link">Build your server image locally</a></li><li class="sidebar-sub-header"><a href="/opex-runbook/docker-k8s/#manage-attached-redis-instances-via-debian" class="sidebar-link">Manage Attached Redis Instances via Debian</a></li><li class="sidebar-sub-header"><a href="/opex-runbook/docker-k8s/#useful-kubernetes-commands" class="sidebar-link">Useful Kubernetes Commands</a></li></ul></li><li><a href="/opex-runbook/postgres/" class="sidebar-link">All Things Postgres</a></li><li><a href="/opex-runbook/domain-forwarder/" class="sidebar-link">Domain Forwarder</a></li><li><a href="/opex-runbook/contributing/" class="sidebar-link">Contributing</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deployments-using-docker-and-kubernetes-aka-k8s"><a href="#deployments-using-docker-and-kubernetes-aka-k8s" class="header-anchor">#</a> Deployments using Docker and Kubernetes (aka K8s)</h1> <p>Our current deployment process uses several technologies.</p> <ul><li><a href="https://cloud.google.com/sdk/docs/install" target="_blank" rel="noopener noreferrer">Install Google Cloud SDK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hub.docker.com/editions/community/docker-ce-desktop-mac" target="_blank" rel="noopener noreferrer">Install Docker Desktop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/" target="_blank" rel="noopener noreferrer">Install Kubernetes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">Install Helm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>(Optional) Install &quot;kubectx&quot; via Homebrew. <code>brew install kubectx</code>.</li></ul> <blockquote><p>NOTE: This workflow may change to use G5's CLI.</p></blockquote> <h2 id="build-your-server-image-locally"><a href="#build-your-server-image-locally" class="header-anchor">#</a> Build your server image locally</h2> <p>Most of OpEx apps have scripts already defined in the NPM package.json at the root of the project. You will want to define some build variables before runing Docker.</p> <p>Copy the <code>.buildenv</code> template file.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">cp</span> .buildenv.TEMPLATE .buildenv
</code></pre></div><p>Fill out each of the variables. These are variables that are only consumed when compiling and are different than runtime variables. Most are consumed directly by Nuxt.js, Vue.js, or its plugins.</p> <blockquote><p>The <code>BROWSER_URL</code> changes dependending on where you are deploying.</p></blockquote> <p>Build, tag, and push. <code>&lt;context&gt;</code> in each command is either <code>prod</code>, <code>staging</code>, or <code>prime</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> run docker:build
<span class="token function">npm</span> run docker:tag:<span class="token operator">&lt;</span>context<span class="token operator">&gt;</span> <span class="token comment"># ex. npm run docker:tag:staging</span>
<span class="token function">npm</span> run docker:push:<span class="token operator">&lt;</span>context<span class="token operator">&gt;</span>
</code></pre></div><p>Upgrade the deployment.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> run helm:upgrade:<span class="token operator">&lt;</span>context<span class="token operator">&gt;</span> <span class="token comment"># ex. npm run helm:upgrade:prod</span>
kubectl get pods
</code></pre></div><p>You should see new pods spinning up.</p> <blockquote><p>Staging and Prime deployments tag their images based on the commit SHA and branch name. If you are redeploying without adding a new commit or changing branches, new pods may not initialize after upgrading. Restart the deployment to finish the upgrade.</p></blockquote> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl rollout restart deployement <span class="token operator">&lt;</span>app_name<span class="token operator">&gt;</span>
</code></pre></div><h2 id="manage-attached-redis-instances-via-debian"><a href="#manage-attached-redis-instances-via-debian" class="header-anchor">#</a> Manage Attached Redis Instances via Debian</h2> <p>Since the Redis instance isn't exposed publicly, and the app may not have tasks to manage the instance directly, you may need to use the <code>redis-cli</code> to communicate with the instance.</p> <p><strong>Spin Up Debian Pod</strong></p> <p>Make sure your K8s context includes the redis instance you want to manage.</p> <p>Deploy a Debian pod.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl run redis-pod --image<span class="token operator">=</span>debian -it -- <span class="token function">bash</span>
</code></pre></div><p>This will end with a command prompt. Install redis tools.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y redis-tools
</code></pre></div><p>Retrieve the private IP for your Redis instance from the Memstore&gt;Redis product in Google Cloud Console. Connect to it via the redis-cli.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-cli -h <span class="token operator">&lt;</span>IP of redis instance<span class="token operator">&gt;</span> <span class="token comment"># do not include the TCP port</span>
</code></pre></div><p>Run your redis commands from here.</p> <p><strong>To Exit</strong></p> <p>Keep typing <code>exit</code> until you get to your local shell.</p> <p>Remove your pod.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete pod redis-pod
</code></pre></div><h2 id="useful-kubernetes-commands"><a href="#useful-kubernetes-commands" class="header-anchor">#</a> Useful Kubernetes Commands</h2> <p>Occasionally, you will accidentally deploy an app to the wrong context. For apps that use Helm and Istio's virtual service the domain routing may get confused. You may even try to fix this, but find that Helm will not deploy the fix despite you fixing the Yaml. Can you force an update or patch?</p> <div class="language- extra-class"><pre class="language-text"><code>helm get manifest &lt;deployment&gt; | k apply -f -
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/opex-runbook/node/" class="prev">
        Configuring your Node.js Environment
      </a></span> <span class="next"><a href="/opex-runbook/postgres/">
        All Things Postgres
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/opex-runbook/assets/js/app.b1c4424b.js" defer></script><script src="/opex-runbook/assets/js/2.83008ae0.js" defer></script><script src="/opex-runbook/assets/js/9.c8b60c0a.js" defer></script>
  </body>
</html>
